
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEPTA — Full Day Schedule + Live Status</title>
  <meta name="theme-color" content="#0b1320"/>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{--bg:#0b1320;--card:#111a2b;--muted:#8aa0c5;--text:#e8f0ff;--accent:#6cf;--good:#1ec27e;--late:#ffb23f;--bad:#ff5d5d}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0f1a32 40%,#0a1222);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:20px 16px;border-bottom:1px solid #1d2b4a;position:sticky;top:0;background:#0b1320cc;backdrop-filter:blur(6px)}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    main{max-width:980px;margin:0 auto;padding:20px 16px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:16px}
    input,select,button{background:#0f1d37;border:1px solid #1d2b4a;color:var(--text);padding:10px 12px;border-radius:12px}
    input{min-width:260px}
    button{cursor:pointer}
    .swap{font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:800px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1d2b4a;border-radius:16px;padding:14px}
    .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .title{font-weight:600}
    .sub{color:var(--muted);font-size:13px}
    .badge{border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid #264066}
    .badge.good{background:#13251d;border-color:#235e45;color:#70f0b1}
    .badge.warn{background:#2a220f;border-color:#6d4e12;color:#ffd27a}
    .badge.bad{background:#2a1313;border-color:#7a2a2a;color:#ff9b9b}
    footer{margin-top:18px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .favbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0f1d37;border:1px solid #1d2b4a;border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip .x{font-size:14px;opacity:.7;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <h1>SEPTA — Full Day Schedule + Live Status</h1>
  </header>

  <main>
    <div class="controls">
      <label class="small muted">From
        <input id="from" list="stations" placeholder="Start typing a station…" value="Elkins Park" autocomplete="off"/>
      </label>
      <label class="small muted">To
        <input id="to" list="stations" placeholder="Start typing a station…" value="Suburban Station" autocomplete="off"/>
      </label>
      <datalist id="stations"></datalist>

      <label class="small muted">Show
        <select id="horizon">
          <option value="2">Next 2 hours</option>
          <option value="6">Next 6 hours</option>
          <option value="24" selected>Next 24 hours</option>
        </select>
      </label>
      <button id="swap" class="swap" title="Swap direction">↕︎ Swap</button>
      <button id="saveFav">★ Save as favorite</button>
      <button id="refresh">Refresh</button>
      <span id="lastUpdated" class="small muted" aria-live="polite"></span>
    </div>

    <div id="favbar" class="favbar"></div>

    <div class="small muted">Full schedules for today (+ tomorrow if needed) via Netlify Function, with live delay from Next‑To‑Arrive merged in.</div>

    <div id="results" class="grid" role="list"></div>

    <footer class="small muted">
      Tip: Install this as a PWA from your browser menu after deploying.
    </footer>
  </main>

  <script>
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    const API_BASE = '/.netlify/functions/septa';

    const NTA_STATIONS = [
      {name:"9th Street Station", param:"9th St"},
      {name:"30th Street Station", param:"30th Street Station"},
      {name:"49th Street", param:"49th St"},
      {name:"Airport Terminal A", param:"Airport Terminal A"},
      {name:"Airport Terminal B", param:"Airport Terminal B"},
      {name:"Airport Terminals C & D", param:"Airport Terminal C-D"},
      {name:"Airport Terminals E & F", param:"Airport Terminal E-F"},
      {name:"Allegheny", param:"Allegheny"},
      {name:"Allen Lane", param:"Allen Lane"},
      {name:"Ambler", param:"Ambler"},
      {name:"Angora", param:"Angora"},
      {name:"Ardmore", param:"Ardmore"},
      {name:"Ardsley", param:"Ardsley"},
      {name:"Bala", param:"Bala"},
      {name:"Berwyn", param:"Berwyn"},
      {name:"Bethayres", param:"Bethayres"},
      {name:"Bridesburg", param:"Bridesburg"},
      {name:"Bristol", param:"Bristol"},
      {name:"Bryn Mawr", param:"Bryn Mawr"},
      {name:"Carpenter", param:"Carpenter"},
      {name:"Chalfont", param:"Chalfont"},
      {name:"Chelten Avenue", param:"Chelten Avenue"},
      {name:"Cheltenham", param:"Cheltenham"},
      {name:"Chester Transportation Center", param:"Chester TC"},
      {name:"Chestnut Hill East", param:"Chestnut Hill East"},
      {name:"Chestnut Hill West", param:"Chestnut Hill West"},
      {name:"Churchmans Crossing", param:"Churchmans Crossing"},
      {name:"Claymont", param:"Claymont"},
      {name:"Clifton-Aldan", param:"Clifton-Aldan"},
      {name:"Colmar", param:"Colmar"},
      {name:"Conshohocken", param:"Conshohocken"},
      {name:"Cornwells Heights", param:"Cornwells Heights"},
      {name:"Crestmont", param:"Crestmont"},
      {name:"Croydon", param:"Croydon"},
      {name:"Crum Lynne", param:"Crum Lynne"},
      {name:"Curtis Park", param:"Curtis Park"},
      {name:"Cynwyd", param:"Cynwyd"},
      {name:"Darby", param:"Darby"},
      {name:"Daylesford", param:"Daylesford"},
      {name:"Delaware Valley College", param:"Delaware Valley College"},
      {name:"Devon", param:"Devon"},
      {name:"Downingtown", param:"Downingtown"},
      {name:"Doylestown", param:"Doylestown"},
      {name:"East Falls", param:"East Falls"},
      {name:"Eastwick Station", param:"Eastwick Station"},
      {name:"Eddington", param:"Eddington"},
      {name:"Eddystone", param:"Eddystone"},
      {name:"Elkins Park", param:"Elkins Park"},
      {name:"Elm Street, Norristown", param:"Elm St"},
      {name:"Elwyn", param:"Elwyn Station"},
      {name:"Exton", param:"Exton"},
      {name:"Fern Rock Transportation Center", param:"Fern Rock TC"},
      {name:"Fernwood–Yeadon", param:"Fernwood"},
      {name:"Folcroft", param:"Folcroft"},
      {name:"Forest Hills", param:"Forest Hills"},
      {name:"Fort Washington", param:"Ft Washington"},
      {name:"Fortuna", param:"Fortuna"},
      {name:"Fox Chase", param:"Fox Chase"},
      {name:"Germantown", param:"Germantown"},
      {name:"Gladstone", param:"Gladstone"},
      {name:"Glenolden", param:"Glenolden"},
      {name:"Glenside", param:"Glenside"},
      {name:"Gravers", param:"Gravers"},
      {name:"Gwynedd Valley", param:"Gwynedd Valley"},
      {name:"Hatboro", param:"Hatboro"},
      {name:"Haverford", param:"Haverford"},
      {name:"Highland", param:"Highland"},
      {name:"Highland Avenue", param:"Highland Ave"},
      {name:"Holmesburg Junction", param:"Holmesburg Jct"},
      {name:"Ivy Ridge", param:"Ivy Ridge"},
      {name:"Jefferson Station (Market East)", param:"Market East"},
      {name:"Jenkintown-Wyncote", param:"Jenkintown-Wyncote"},
      {name:"Langhorne", param:"Langhorne"},
      {name:"Lansdale", param:"Lansdale"},
      {name:"Lansdowne", param:"Lansdowne"},
      {name:"Lawndale", param:"Lawndale"},
      {name:"Levittown", param:"Levittown"},
      {name:"Link Belt", param:"Link Belt"},
      {name:"Main Street, Norristown", param:"Main St"},
      {name:"Malvern", param:"Malvern"},
      {name:"Manayunk", param:"Manayunk"},
      {name:"Marcus Hook", param:"Marcus Hook"},
      {name:"Meadowbrook", param:"Meadowbrook"},
      {name:"Media", param:"Media"},
      {name:"Melrose Park", param:"Melrose Park"},
      {name:"Merion", param:"Merion"},
      {name:"Miquon", param:"Miquon"},
      {name:"Morton", param:"Morton"},
      {name:"Mount Airy", param:"Mt Airy"},
      {name:"Moylan-Rose Valley", param:"Moylan-Rose Valley"},
      {name:"Narberth", param:"Narberth"},
      {name:"Neshaminy Falls", param:"Neshaminy Falls"},
      {name:"New Britain", param:"New Britain"},
      {name:"Newark", param:"Newark"},
      {name:"Noble", param:"Noble"},
      {name:"Norristown Transportation Center", param:"Norristown TC"},
      {name:"North Broad", param:"North Broad St"},
      {name:"North Hills", param:"North Hills"},
      {name:"North Philadelphia", param:"North Philadelphia"},
      {name:"North Wales", param:"North Wales"},
      {name:"Norwood", param:"Norwood"},
      {name:"Olney", param:"Olney"},
      {name:"Oreland", param:"Oreland"},
      {name:"Overbrook", param:"Overbrook"},
      {name:"Paoli", param:"Paoli"},
      {name:"Penllyn", param:"Penllyn"},
      {name:"Pennbrook", param:"Pennbrook"},
      {name:"Penn Medicine Station (University City)", param:"Penn Medicine Station"},
      {name:"Philmont", param:"Philmont"},
      {name:"Primos", param:"Primos"},
      {name:"Prospect Park", param:"Prospect Park"},
      {name:"Queen Lane", param:"Queen Lane"},
      {name:"Radnor", param:"Radnor"},
      {name:"Ridley Park", param:"Ridley Park"},
      {name:"Rosemont", param:"Rosemont"},
      {name:"Roslyn", param:"Roslyn"},
      {name:"Rydal", param:"Rydal"},
      {name:"Ryers", param:"Ryers"},
      {name:"Secane", param:"Secane"},
      {name:"Sedgwick", param:"Sedgwick"},
      {name:"Sharon Hill", param:"Sharon Hill"},
      {name:"Somerton", param:"Somerton"},
      {name:"Spring Mill", param:"Spring Mill"},
      {name:"St. Davids", param:"St. Davids"},
      {name:"St. Martins", param:"St. Martins"},
      {name:"Stenton", param:"Stenton"},
      {name:"Strafford", param:"Strafford"},
      {name:"Suburban Station", param:"Suburban Station"},
      {name:"Swarthmore", param:"Swarthmore"},
      {name:"Tacony", param:"Tacony"},
      {name:"Temple University", param:"Temple U"},
      {name:"Thorndale", param:"Thorndale"},
      {name:"Torresdale", param:"Torresdale"},
      {name:"Trenton Transit Center", param:"Trenton"},
      {name:"Trevose", param:"Trevose"},
      {name:"Tulpehocken", param:"Tulpehocken"},
      {name:"Upsal", param:"Upsal"},
      {name:"Villanova", param:"Villanova"},
      {name:"Wallingford", param:"Wallingford"},
      {name:"Warminster", param:"Warminster"},
      {name:"Washington Lane", param:"Washington Lane"},
      {name:"Wayne", param:"Wayne"},
      {name:"Wayne Junction", param:"Wayne Jct"},
      {name:"West Trenton", param:"West Trenton"},
      {name:"Whitford", param:"Whitford"},
      {name:"Willow Grove", param:"Willow Grove"},
      {name:"Wilmington", param:"Wilmington"},
      {name:"Wissahickon", param:"Wissahickon"},
      {name:"Wister", param:"Wister"},
      {name:"Woodbourne", param:"Woodbourne"},
      {name:"Wyndmoor", param:"Wyndmoor"},
      {name:"Wynnefield Avenue", param:"Wynnefield Avenue"},
      {name:"Wynnewood", param:"Wynnewood"},
      {name:"Yardley", param:"Yardley"}
    ];

    const fromSel = document.getElementById('from');
    const toSel = document.getElementById('to');
    const stationDatalist = document.getElementById('stations');
    const results = document.getElementById('results');
    const lastUpdated = document.getElementById('lastUpdated');
    const swapBtn = document.getElementById('swap');
    const saveFavBtn = document.getElementById('saveFav');
    const refreshBtn = document.getElementById('refresh');
    const horizonSel = document.getElementById('horizon');
    const favbar = document.getElementById('favbar');

    // ---- Favorites ----
    const FKEY = 'septa_favorites_v1';
    function loadFavs(){
      try{ return JSON.parse(localStorage.getItem(FKEY)) || []; }catch{ return []; }
    }
    function saveFavs(f){ localStorage.setItem(FKEY, JSON.stringify(f)); }
    function uniqKey(a){ return (a.from||'')+'|'+(a.to||''); }

    function ensureDefaults(){
      const f = loadFavs();
      const defaults = [
        {from:'Elkins Park', to:'Suburban Station'},
        {from:'Suburban Station', to:'Elkins Park'}
      ];
      let changed = false;
      defaults.forEach(d => {
        if(!f.find(x => uniqKey(x)===uniqKey(d))){ f.push(d); changed = true; }
      });
      if(changed) saveFavs(f);
    }

    function renderFavs(){
      const f = loadFavs();
      favbar.innerHTML = '';
      f.forEach((fav, idx) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>⭐ ${fav.from} → ${fav.to}</span> <span class="x" title="Remove">×</span>`;
        chip.addEventListener('click', (e) => {
          if(e.target.classList.contains('x')) return; // ignore remove click
          fromSel.value = fav.from; toSel.value = fav.to; run();
        });
        chip.querySelector('.x').addEventListener('click', (e) => {
          e.stopPropagation();
          const f2 = loadFavs().filter((_,i)=>i!==idx);
          saveFavs(f2); renderFavs();
        });
        favbar.appendChild(chip);
      });
    }

    function addCurrentAsFav(){
      const from = fromSel.value.trim(), to = toSel.value.trim();
      if(!from || !to || from===to) return alert('Pick two different stations first.');
      const f = loadFavs();
      if(!f.find(x => x.from===from && x.to===to)){
        f.unshift({from,to});
        if(f.length>8) f.pop();
        saveFavs(f); renderFavs();
      } else {
        alert('Already in favorites.');
      }
    }

    // ---- Station picker ----
    function populate(){
      stationDatalist.innerHTML = '';
      const ordered = NTA_STATIONS.map(s => s.name).sort((a,b)=>a.localeCompare(b));
      ordered.forEach(n => { const opt = document.createElement('option'); opt.value = n; stationDatalist.appendChild(opt); });
    }
    function findParam(name){
      const n = (name||'').trim().toLowerCase();
      const hit = NTA_STATIONS.find(s => s.name.toLowerCase() === n);
      return hit ? hit.param : name;
    }

    // ---- Data + UI handlers ----
    swapBtn.addEventListener('click', () => { const f = fromSel.value; fromSel.value = toSel.value; toSel.value = f; run(); });
    saveFavBtn.addEventListener('click', addCurrentAsFav);
    refreshBtn.addEventListener('click', run);
    fromSel.addEventListener('change', run);
    toSel.addEventListener('change', run);
    horizonSel.addEventListener('change', run);

    function ymd(d){ return d.toISOString().slice(0,10); }

    async function run(){
      const fromName = fromSel.value, toName = toSel.value;
      if(!fromName || !toName) return;
      if(fromName === toName){ alert('Choose two different stations.'); return; }
      const from = findParam(fromName), to = findParam(toName);
      const hours = parseInt(horizonSel.value,10) || 2;

      results.innerHTML = '<div class="card">Loading schedule…</div>';

      const now = new Date();
      const end = new Date(now.getTime() + hours*3600*1000);

      const p = [fetch(`${API_BASE}?type=schedule&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&date=${ymd(now)}`).then(r=>r.json())];
      if(end.getDate() != now.getDate()){
        const tmr = new Date(now); tmr.setDate(now.getDate()+1);
        p.push(fetch(`${API_BASE}?type=schedule&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&date=${ymd(tmr)}`).then(r=>r.json()));
      } else { p.push(Promise.resolve([])); }
      p.push(fetch(`${API_BASE}?type=nta&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&count=200`).then(r=>r.json()));

      let [schedToday, schedTomorrow, nta] = await Promise.all(p);
      if(!Array.isArray(schedToday)) schedToday = [];
      if(!Array.isArray(schedTomorrow)) schedTomorrow = [];
      if(!Array.isArray(nta)) nta = [];

      const schedule = normalizeSchedule(schedToday).concat(normalizeSchedule(schedTomorrow));
      const filtered = horizonFilter(schedule, now, end);
      const merged = mergeLive(filtered, nta);

      render(merged);
      lastUpdated.textContent = 'Updated ' + new Date().toLocaleTimeString();
    }

    function normalizeSchedule(arr){
      const out = [];
      arr.forEach(row => {
        const depart = row.departure_time || row.orig_departure_time || row.depart_time || row.orig_time || row.time_departure;
        const arrive = row.arrival_time || row.term_arrival_time || row.time_arrival;
        const line = row.line || row.route || row.branch;
        const train = row.train || row.train_id || row.orig_train;
        if(depart || arrive){ out.push({depart, arrive, line, train}); }
      });
      return out;
    }

    function parseTimeToDate(t, refDate){
      if(!t) return null;
      const base = new Date(refDate.getFullYear(), refDate.getMonth(), refDate.getDate(), 0,0,0,0);
      const m = (t+'').trim().match(/^(\d{1,2}):(\d{2})(?:\s*([AP]M))?$/i);
      let d=null;
      if(m){
        let hh = parseInt(m[1],10), mm = parseInt(m[2],10);
        const ap = (m[3]||'').toUpperCase();
        if(ap){ if(ap==='PM' && hh<12) hh+=12; if(ap==='AM' && hh===12) hh=0; }
        d = new Date(base); d.setHours(hh, mm, 0, 0);
      }
      return d;
    }

    function horizonFilter(trips, start, end){
      return trips.filter(t => {
        const dt = parseTimeToDate(t.depart, start);
        let d = dt;
        if(d && d.getTime() < start.getTime() - 2*3600*1000){ d = new Date(d.getTime()+86400000); }
        return d && d >= new Date(start.getTime()-5*60000) && d <= end;
      });
    }

    function toBadge(status){
      const s = (status||'').toLowerCase();
      if(/cancel/.test(s)) return ['bad','Canceled'];
      if(/suspend/.test(s)) return ['bad','Suspended'];
      if(/on[- ]?time/.test(s)) return ['good','On time'];
      const m = s.match(/(\d+)\s*min/);
      if(m) return ['warn', `${parseInt(m[1],10)} min late`];
      return ['warn', status||'Scheduled'];
    }

    function mergeLive(scheduleTrips, ntaTrips){
      const idx = {};
      ntaTrips.forEach(n => {
        const depart = n.orig_departure_time || n.orig_time || n.departure_time || n.OrigSchDep;
        const train = n.orig_train || n.train_id || n.train;
        const key = (depart||'') + '|' + (train||'');
        idx[key] = n;
      });
      return scheduleTrips.map(s => {
        const key = (s.depart||'') + '|' + (s.train||'');
        const live = idx[key] || null;
        const status = live ? (live.status || live.orig_delay || live.term_status || live.term_delay || 'On time') : 'Scheduled';
        const [cls, badge] = toBadge(status);
        const delay = ((status||'').match(/(\d+)\s*min/)||[])[1];
        const eta = parseTimeToDate(s.arrive, new Date());
        let etaTxt = s.arrive || '—';
        if(eta && delay){ eta.setMinutes(eta.getMinutes()+parseInt(delay,10)); etaTxt = fmtTime(eta); }
        return { ...s, status, badgeClass:cls, badgeText:badge, etaTxt };
      });
    }

    function fmtTime(d){
      if(!d) return '—';
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2,'0');
      const ap = h>=12 ? 'PM' : 'AM';
      h = h%12 || 12;
      return `${h}:${m}${ap}`;
    }

    function render(items){
      if(!items.length){
        results.innerHTML = '<div class="card">No trips in this window.</div>';
        return;
      }
      results.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="row">
            <div>
              <div class="title">${item.depart || '—'} → ${item.arrive || '—'}</div>
              <div class="sub">${item.line ? item.line + ' line • ' : ''}${item.train ? 'Train ' + item.train : ''}</div>
              <div class="sub">Expected arrival: <strong>${item.etaTxt}</strong>${item.arrive && item.etaTxt!==item.arrive ? ' (sched ' + item.arrive + ')' : ''}</div>
            </div>
            <div class="badge ${item.badgeClass}" title="${item.status || ''}">${item.badgeText}</div>
          </div>
        `;
        results.appendChild(div);
      });
    }

    // Init
    (function init(){
      populate();
      ensureDefaults();
      renderFavs();
      run();
    })();
  </script>
</body>
</html>
